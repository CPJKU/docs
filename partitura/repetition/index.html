<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.2.0 for Hugo"><meta name=description content="Learn how Partitura and the Match Format handles repetitions during the performance's score unfolding."><link rel=alternate hreflang=en-us href=http://sildater.github.io/docs/partitura/repetition/><link rel=preconnect href=https://fonts.gstatic.com crossorigin><meta name=theme-color content="#1565c0"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin=anonymous><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload="this.media='all'"><link rel=stylesheet href=/docs/css/wowchemy.7145a9a307b7b6e0cf40149bdecd66b5.css><link rel=alternate href=/docs/partitura/repetition/index.xml type=application/rss+xml title="CPJKU Documentation"><link rel=manifest href=/docs/index.webmanifest><link rel=icon type=image/png href=/docs/media/icon_hu6d1ba421daacf30ae3c4e159e6645876_317832_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/docs/media/icon_hu6d1ba421daacf30ae3c4e159e6645876_317832_180x180_fill_lanczos_center_2.png><link rel=canonical href=http://sildater.github.io/docs/partitura/repetition/><meta property="twitter:card" content="summary"><meta property="og:site_name" content="CPJKU Documentation"><meta property="og:url" content="http://sildater.github.io/docs/partitura/repetition/"><meta property="og:title" content="Repetition Handling | CPJKU Documentation"><meta property="og:description" content="Learn how Partitura and the Match Format handles repetitions during the performance's score unfolding."><meta property="og:image" content="http://sildater.github.io/docs/media/icon_hu6d1ba421daacf30ae3c4e159e6645876_317832_512x512_fill_lanczos_center_2.png"><meta property="twitter:image" content="http://sildater.github.io/docs/media/icon_hu6d1ba421daacf30ae3c4e159e6645876_317832_512x512_fill_lanczos_center_2.png"><meta property="og:locale" content="en-us"><title>Repetition Handling | CPJKU Documentation</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=605a5579e13554efc57eac8a366213c2><script src=/docs/js/wowchemy-init.min.b8153d4570dcbb34350a2a846dba8c03.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class=page-header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/docs/>CPJKU Documentation</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/docs/>CPJKU Documentation</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/docs/match/><span>Match</span></a></li><li class=nav-item><a class="nav-link active" href=/docs/partitura/><span>Partitura</span></a></li><li class=nav-item><a class=nav-link href=/docs/nopage/><span>Struttura</span></a></li><li class=nav-item><a class=nav-link href=/docs/nopage/><span>MatchMaker</span></a></li><li class=nav-item><a class=nav-link href=/docs/nopage/><span>BasisMixer</span></a></li><li class=nav-item><a class=nav-link href=/docs/nopage/><span>Accompanion</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></div><div class=page-body><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 docs-sidebar"><form class="docs-search d-flex align-items-center"><button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type=button data-toggle=collapse data-target=#docs-nav aria-controls=docs-nav aria-expanded=false aria-label="Toggle section navigation"><div class=d-flex><span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">Partitura</span>
<span><i class="fas fa-chevron-down"></i></span></div></button>
<button class="form-control sidebar-search js-search d-none d-md-flex">
<i class="fas fa-search pr-2"></i>
<span class=sidebar-search-text>Search...</span>
<span class=sidebar-search-shortcut>/</span></button></form><nav class="collapse docs-links" id=docs-nav><ul class="nav docs-sidenav"><li><a href=/docs/partitura/>Partitura</a></li><div class=docs-toc-item><a class=docs-toc-link href=/docs/partitura/introduction/>Overview of Partitura</a></div><div class=docs-toc-item><a class="docs-toc-link active" href=/docs/partitura/repetition/>Repetition Handling</a></div><div class=docs-toc-item><a class=docs-toc-link href=/docs/partitura/matchparsing/>Match Handling</a></div></ul></nav></div><div class="d-none d-xl-block col-xl-2 docs-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>Contents</a></li></ul><nav id=TableOfContents><ul><li><ul><li><a href=#todo-this-page-is-just-a-proposal-for-rep-handling-in-partitura-and-a-pr-update-and-move>TODO: this page is just a proposal for rep handling in partitura and a PR, update and move!</a></li></ul></li><li><a href=#repetition-handling>Repetition Handling</a><ul><li><a href=#some-background>Some background</a></li></ul></li><li><a href=#my-proposal-for-a-segment-object>my proposal for a Segment object</a></li></ul><ul><li><a href=#why>Why?</a></li><li><a href=#how>How?</a></li><li><a href=#other-bits-and-fixes>Other Bits and Fixes:</a></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role=main><article class=article><div class=docs-article-container><nav class="d-none d-md-flex" aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=/docs/>Home</a></li><li class=breadcrumb-item><a href=/docs/partitura/>Partitura</a></li><li class="breadcrumb-item active" aria-current=page>Repetition Handling</li></ol></nav><h1>Repetition Handling</h1><div class=article-style><h3 id=todo-this-page-is-just-a-proposal-for-rep-handling-in-partitura-and-a-pr-update-and-move>TODO: this page is just a proposal for rep handling in partitura and a PR, update and move!</h3><h2 id=repetition-handling>Repetition Handling</h2><h3 id=some-background>Some background</h3><p>Currently the repeat object is a simple <em>TimedObject</em> with start and end time.</p><p>Repeat objects are read from xml barline objects with repeat and Volta brackets are read from barline objects with &ldquo;ending&rdquo; property in <code>partitura.score.Ending</code> obejects and have a number property.</p><p>This allows for the creation of <em>ScoreVariants</em> based on <em>Repeats</em> for the unfolding of parts.</p><p>There are several limit cases to unfolding/segmentation:</p><ul><li>the endpoint of Ending objects (encoding a Volta bracket) is not automatically inferred</li><li>Volta brackets with >2 endings are not supported</li><li>Nested repeats are not supported</li><li>all other navigation marks (segno, coda, capo, fine, &mldr;?) are not supported</li></ul><p>The <em>ScoreVariant</em> itself allows for segment-type/jump-type-agnostic <em>ScoreVariants</em>. As far as I understand the ScoreVariant contains a segment list of the structure:</p><pre><code>sv.segments = [(0,6,0),(0,6,6)(6,10,12)]
</code></pre><p>where the three numbers mean (start of segment, end of segment, cumulative/unfolded start of segment)</p><p>see this example by Francesco:</p><p><img src=./excerpt.jpeg alt></p><p>where the possible omissions of repeats lead to these four segment lists:</p><pre><code>[(0, 4, 0), (4, 6, 4), (6, 12, 6), (14, 22, 12)] [(0, 4, 0), (4, 6, 4), (6, 14, 6), (6, 12, 14), (14, 22, 20)] [(0, 4, 0), (0, 4, 4), (4, 6, 8), (6, 12, 10), (14, 22, 16)] [(0, 4, 0), (0, 4, 4), (4, 6, 8), (6, 14, 10), (6, 12, 18), (14, 22, 24)]
</code></pre><p>These segments and the corresponding ScoreVariants are created from the Repeat objects. As you can see the da capo and fine are ignored. but segments can also be added to a ScoreVariant, they are just defined by positions.</p><h2 id=my-proposal-for-a-segment-object>my proposal for a Segment object</h2><p>I think these problems of unfolding could be solved with a partitura.score.Segment object:</p><pre><code>class Segment(TimedObject):    &quot;&quot;&quot;Class that represents any segment between two navigation markers     Parameters    ----------    id : int/string        The ID associated with this segment    jump_to : list of int/string        The IDs of segments where the unfolded score could jump to at the end of this segment     Attributes    ----------    id : int/string        See parameters    jump_to : list of int/string        See parameters    jump_id : int        the id     &quot;&quot;&quot;     def __init__(self, id, jump_to):        super().__init__()        self.id = id        self.jump_to = jump_to        self.jump_id = 0 
</code></pre><p>Let&rsquo;s go back to the score example above. This part would contain 5 segments:</p><ul><li>the first 4 beats, let&rsquo;s call it a</li><li>the beats 4 - 6 : b</li><li>6 - 12 : c</li><li>12 - 14 : d</li><li>14 - 22 : e</li></ul><p>and their jump_to properties would look like this:</p><pre><code>a.jump_to = [&quot;a&quot;, &quot;b&quot;] b.jump_to = [&quot;c&quot;] c.jump_to = [&quot;d&quot;, &quot;e&quot;, end] d.jump_to = [&quot;c&quot;] e.jump_to = [&quot;a&quot;, end] # since it would be an option to not play the da capo?
</code></pre><h1 id=pr>PR</h1><h1 id=general-score-unfolding-overhaul>General Score Unfolding Overhaul</h1><p>This PR contains the following new things in partitura.score.py:</p><ul><li><p><code>class Segment(TimedObject)</code>: a segment of a part between two time points that are relevant to the repetition structure</p><ul><li><code>add_segments(part)</code>: a function adding segments to a part based on existing TimedObjects: Repeat, Ending, DaCapo, DalSegno, Segno, AlCoda, Coda, Fine</li><li><code>get_segments(part)</code>: returns a dict of segments indexed by segment ID</li><li><code>pretty_segments(part)</code>: creates a pretty string describing the segments of a part</li></ul></li><li><p><code>class Path</code>: a Path object encodes a sequence of segments and utility needed to extend that sequence, if it hasn&rsquo;t reached an end of the part.</p><ul><li><code>unfold_paths(*args)</code>: recursively unfold and multiply a Path into all possible Paths and store these in a list</li><li><code>get_paths(part, *args)</code>: call unfold_paths with the starting segment Path and return the resulting paths as parametrized (for options, see below)</li><li><code>new_part_from_path(*args)</code>: create a new part from a Path</li><li><code>new_scorevariant_from_path(*args)</code>: create a new ScoreVariant from a Path</li></ul></li><li><p>Updated functions from which now use the new unfolding:</p><ul><li><code>iter_unfolded_parts(*args)</code>: iterator over all unfolded parts</li><li><code>unfolded_part_maximal(*args)</code>: returns the longest unfolded part</li><li><code>unfolded_part_alignment(*args)</code>: returns the unfolded part that best fits the note IDs in an alignment</li><li><code>make_score_variants(*args)</code>: creates a list of ScoreVariant objects</li></ul></li></ul><h2 id=why>Why?</h2><p>Theses changes solve limit cases of unfolding/segmentation:</p><ul><li>Volta brackets with >2 endings are supported</li><li>Nested repeats are supported</li><li>Other navigation marks (segno, coda, capo, fine) are supported</li></ul><p>Additionally, the changes make the following possible:</p><ul><li>get all unfoldings with some specific constraints:<ul><li>all!</li><li>the longest!</li><li>the longest without repeats after a jump mark (dal segno, al cado, da capo)</li><li>all without repeats after a jump mark (dal segno, al cado, da capo)</li><li>the shortest</li></ul></li><li>create any unfolding:<ul><li>pick any segment(s) you like from the list of segments (<code>print(partitura.score.pretty_segments(part))</code> for an overview)</li><li>add them to a path <code>p = Path(["C","K","&",...], segments)</code></li><li>create a new part from this path <code>new_part = new_part_from_path(p, part)</code></li></ul></li><li>get informative strings about segments and paths:<ul><li>as above: <code>print(partitura.score.pretty_segments(part))</code></li><li>for paths use <code>print(path)</code> or <code>print(path.pretty())</code></li></ul></li></ul><h2 id=how>How?</h2><p>The Segments add information about the structure and the possible jumps from every segment to the part.
The Path parses this tree of possible unfoldings (with constraints, if desired).
The ScoreVariant creates a variant of the score based on the list of of segment IDs stored (or possibly computed) in a Path.</p><h2 id=other-bits-and-fixes>Other Bits and Fixes:</h2><ul><li><code>load_musicxml</code>: correct parsing of location attribute of barline tag</li><li><code>load_musicxml</code>: correct parsing of navigation markers (Da Capo, Al Segno, Segno, Al Coda, Coda, Fine)</li><li><code>score.py</code>: TimedObject subclasses for navigation markers</li><li><code>ScoreVariant.create_variant_part()</code>: Ignore the following score elements for the new part: Repeat, Ending, ToCoda, DaCapo, DalSegno, Segment, Page, System</li><li><code>ScoreVariant.create_variant_part()</code>: Check for previous clefs before adding new clef element</li><li>modified the unfolding unittest and added a new more complex test for unfolding with jumps and three Volta brackets</li><li>added <code>part.measure_number_map</code>here</li><li>added test for <code>part.measure_number_map</code></li><li>marked five functions as DEPRECATED (TODO: remove before merge)</li></ul></div><div class=article-widget><div class=post-nav></div></div></div><div class=body-footer><p>Last updated on Jan 1, 0001</p></div></article></main></div></div></div><div class=page-footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin=anonymous></script><script>anchors.add()</script><script id=search-hit-fuse-template type=text/x-template>
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/docs/js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js></script><script src=/docs/en/js/wowchemy.min.ed81448fe12599f2724355b420833386.js></script></body></html>